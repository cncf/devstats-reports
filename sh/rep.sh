#!/bin/bash
# SKIPDT=1 - skip from,to ranges in the final out.csv output file.
# CUMULATIVE=2015-01-01 - calculate cumulative values from 2015-01-01
# CSV=file.csv - overwrite default CSV name
if [ -z "$PG_PASS" ]
then
  echo "$0: you need to set PG_PASS=..."
  exit 1
fi

if [ -z "$1" ]
then
  echo "$0: you need to provide 1st argument - report type: join, quarters, years, YYYY-MM-DD, all"
  exit 2
fi

if [ -z "$2" ]
then
  echo "$0: you need to provide 2nd argument - report name, for example developers_count"
  exit 3
fi

rm -f 201*.csv

data=''
if [ "$1" = "quarters" ]
then
  data='2014-01-01:2014-04-01 2014-04-01:2014-07-01 2014-07-01:2014-10-01 2014-10-01:2015-01-01 2015-01-01:2015-04-01 2015-04-01:2015-07-01 2015-07-01:2015-10-01 2015-10-01:2016-01-01 2016-01-01:2016-04-01 2016-04-01:2016-07-01 2016-07-01:2016-10-01 2016-10-01:2017-01-01 2017-01-01:2017-04-01 2017-04-01:2017-07-01 2017-07-01:2017-10-01 2017-10-01:2018-01-01 2018-01-01:2018-04-01 2018-04-01:2018-07-01 2018-07-01:2018-10-01 2018-10-01:2019-01-01 2019-01-01:2019-04-01 2019-04-01:2019-07-01 2019-07-01:2019-10-01 2019-10-01:2020-01-01 2020-01-01:2020-04-01 2020-04-01:2020-07-01 2020-07-01:2020-10-01 2020-10-01:2021-01-01 2021-01-01:2021-04-01 2021-04-01:2021-07-01'
fi
if [ "$1" = "years" ]
then
  data='2014-01-01:2015-01-01 2015-01-01:2016-01-01 2016-01-01:2017-01-01 2017-01-01:2018-01-01 2018-01-01:2019-01-01 2019-01-01:2020-01-01 2020-01-01:2021-01-01 2021-01-01:2022-01-01'
fi
if [ "$1" = "join" ]
then
  data='2010-01-01:2016-03-10 2016-03-10:2080-01-01'
fi
if [ "$1" = "prometheus_join" ]
then
  data='2010-01-01:2016-05-09 2016-05-09:2080-01-01'
fi
if [ "$1" = "envoy_join" ]
then
  data='2016-09-01:2017-09-13 2017-09-13:2080-01-01'
fi
if [ "$1" = "containerd_join" ]
then
  data='2015-12-17:2017-03-29 2017-03-29:2080-01-01'
fi
if [ "$1" = "fluentd_join" ]
then
  data='2014-01-01:2016-11-08 2016-11-08:2080-01-01'
fi
if [ "$1" = "vitess_join" ]
then
  data='2014-01-01:2018-02-05 2018-02-05:2080-01-01'
fi
if [ "$1" = "helm_join" ]
then
  data='2015-10-06:2018-06-01 2018-06-01:2080-01-01'
fi
if [ "$1" = "jaeger_join" ]
then
  data='2016-11-01:2017-09-13 2017-09-13:2080-01-01'
fi
if [ "$1" = "harbor_join" ]
then
  data='2016-03-02:2018-07-31 2018-07-31:2080-01-01'
fi
if [ "$1" = "etcd_join" ]
then
  data='2014-01-01:2018-12-11 2018-12-11:2080-01-01'
fi
if [ "$1" = "all" ]
then
  data="2010-01-01:2080-01-01"
fi
if [ "$1" = "months" ]
then
  data='2014-01-01:2014-02-01 2014-02-01:2014-03-01 2014-03-01:2014-04-01 2014-04-01:2014-05-01 2014-05-01:2014-06-01 2014-06-01:2014-07-01 2014-07-01:2014-08-01 2014-08-01:2014-09-01 2014-09-01:2014-10-01 2014-10-01:2014-11-01 2014-11-01:2014-12-01 2014-12-01:2015-01-01 2015-01-01:2015-02-01 2015-02-01:2015-03-01 2015-03-01:2015-04-01 2015-04-01:2015-05-01 2015-05-01:2015-06-01 2015-06-01:2015-07-01 2015-07-01:2015-08-01 2015-08-01:2015-09-01 2015-09-01:2015-10-01 2015-10-01:2015-11-01 2015-11-01:2015-12-01 2015-12-01:2016-01-01 2016-01-01:2016-02-01 2016-02-01:2016-03-01 2016-03-01:2016-04-01 2016-04-01:2016-05-01 2016-05-01:2016-06-01 2016-06-01:2016-07-01 2016-07-01:2016-08-01 2016-08-01:2016-09-01 2016-09-01:2016-10-01 2016-10-01:2016-11-01 2016-11-01:2016-12-01 2016-12-01:2017-01-01 2017-01-01:2017-02-01 2017-02-01:2017-03-01 2017-03-01:2017-04-01 2017-04-01:2017-05-01 2017-05-01:2017-06-01 2017-06-01:2017-07-01 2017-07-01:2017-08-01 2017-08-01:2017-09-01 2017-09-01:2017-10-01 2017-10-01:2017-11-01 2017-11-01:2017-12-01 2017-12-01:2018-01-01 2018-01-01:2018-02-01 2018-02-01:2018-03-01 2018-03-01:2018-04-01 2018-04-01:2018-05-01 2018-05-01:2018-06-01 2018-06-01:2018-07-01 2018-07-01:2018-08-01 2018-08-01:2018-09-01 2018-09-01:2018-10-01 2018-10-01:2018-11-01 2018-11-01:2018-12-01 2018-12-01:2019-01-01 2019-01-01:2019-02-01 2019-02-01:2019-03-01 2019-03-01:2019-04-01 2019-04-01:2019-05-01 2019-05-01:2019-06-01 2019-06-01:2019-07-01 2019-07-01:2019-08-01 2019-08-01:2019-09-01 2019-09-01:2019-10-01 2019-10-01:2019-11-01 2019-11-01:2019-12-01 2019-12-01:2020-01-01 2020-01-01:2020-02-01 2020-02-01:2020-03-01 2020-03-01:2020-04-01 2020-04-01:2020-05-01 2020-05-01:2020-06-01 2020-06-01:2020-07-01 2020-07-01:2020-08-01 2020-08-01:2020-09-01 2020-09-01:2020-10-01 2020-10-01:2020-11-01 2020-11-01:2020-12-01 2020-12-01:2021-01-01 2021-01-01:2021-02-01 2021-02-01:2021-03-01 2021-03-01:2021-04-01 2021-04-01:2021-05-01'
fi

if [ "$data" = "" ]
then
  data="2010-01-01:$1 $1:2080-01-01"
fi

if [ -z "$CSV" ]
then
  rm -f "20*.csv"
fi

for row in $data
do
  row=${row//:/ }
  ary=($row)
  if [ -z "$CUMULATIVE" ]
  then
    dfrom="${ary[0]}"
  else
    dfrom="${CUMULATIVE}"
  fi
  dto=${ary[1]}
  if ( [ "$dfrom" \> "$dto" ] || [ "$dfrom" = "$dto" ] )
  then
    continue
  fi
  echo "Range ${dfrom} ${ary[1]}"
  if [ -z "$CSV" ]
  then
    GHA2DB_CSVOUT="${dfrom}_${ary[1]}.csv" ./sh/run.sh "${2}" "${dfrom}" "${ary[1]}" "${@:3:99}" || exit 4
  else
    GHA2DB_CSVOUT="${CSV}" ./sh/run.sh "${2}" "${dfrom}" "${ary[1]}" "${@:3:99}" || exit 5
  fi
done
hdr=''
for row in $data
do
  row=${row//:/ }
  ary=($row)
  if [ -z "$CUMULATIVE" ]
  then
    dfrom="${ary[0]}"
  else
    dfrom="${CUMULATIVE}"
  fi
  dto=${ary[1]}
  if ( [ "$dfrom" \> "$dto" ] || [ "$dfrom" = "$dto" ] )
  then
    continue
  fi
  echo "Merge ${dfrom} - ${ary[1]}"
  if [ -z "$hdr" ]
  then
    hdr=`head -n 1 "${dfrom}_${ary[1]}.csv"`
    if [ -z "$SKIPDT" ]
    then
      hdr="from,to,${hdr}"
    fi
    echo $hdr > out.csv
  fi
  rows=`tail -n +2 "${dfrom}_${ary[1]}.csv"`
  for row in $rows
  do
    if [ -z "$SKIPDT" ]
    then
      echo "${dfrom},${ary[1]},$row" >> out.csv
    else
      echo "$row" >> out.csv
    fi
  done
done
